<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>PageContainer: Fast, Direct Data I/O Without OS Buffering | Vision Tech Insights</title>
<meta name=keywords content="hardware programming,C++"><meta name=description content="A comprehensive guide on how to build a C++ data structure enabling direct data IO without OS buffering"><meta name=author content="Jian Zhong"><link rel=canonical href=http://localhost:1313/posts/page_container_direct_data_io/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.5ff2630c4d1b3e25bc21f0ecd96681dbcf58219e741fa627857820b5485cb770.css integrity="sha256-X/JjDE0bPiW8IfDs2WaB289YIZ50H6YnhXggtUhct3A=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/page_container_direct_data_io/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="PageContainer: Fast, Direct Data I/O Without OS Buffering"><meta property="og:description" content="A comprehensive guide on how to build a C++ data structure enabling direct data IO without OS buffering"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/page_container_direct_data_io/"><meta property="og:image" content="http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-13T00:00:00+00:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure.png"><meta name=twitter:title content="PageContainer: Fast, Direct Data I/O Without OS Buffering"><meta name=twitter:description content="A comprehensive guide on how to build a C++ data structure enabling direct data IO without OS buffering"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"PageContainer: Fast, Direct Data I/O Without OS Buffering","item":"http://localhost:1313/posts/page_container_direct_data_io/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"PageContainer: Fast, Direct Data I/O Without OS Buffering","name":"PageContainer: Fast, Direct Data I\/O Without OS Buffering","description":"A comprehensive guide on how to build a C++ data structure enabling direct data IO without OS buffering","keywords":["hardware programming","C++"],"articleBody":"When creating high-speed data streaming applications, it’s important to avoid unnecessary data transfer to keep things fast and efficient. Operating systems (OS) automatically buffer file input/output (I/O) in the computer’s memory. However, many data streaming applications already have their own buffering steps, making the OS’s additional buffering unnecessary. Disabling this OS buffering allows direct control of data transfer, but it requires the application to access data in sizes that are multiples of the system page size (or disk sector size).\nThis blog post will show you how to build a C++ data structure called PageContainer that lets you access data without the OS buffering. You can find the ready-to-use source code for PageContainer in my Github repository.(URL: https://github.com/JianZhongDev/PageContainer )\nContainer Class Requirements For applications that need to read and write large amounts of data without OS buffering, the data container should meet the following requirements:\nThe buffer size should be a multiple of the page size. It should be able to store data whose size does not perfectly match multiples of the page size It should be capable of saving multiple containers within a large file. The PageContainer Class To meet the requirements for accessing data without OS buffering, we can create a PageContainer class. The following sections will explain each part of this class in detail.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 namespace Container{ typedef int errflag_t; static const errflag_t ERR_NULL = 0; static const errflag_t SUCCESS = 1; static const errflag_t ERR_FAILED = -1; static const errflag_t ERR_MEMERR = -2; // return errflag for fast error handling template\u003ctypename dtype\u003e class PageContainer { private: void* buffer_p = nullptr; size_t* buffer_size_p = nullptr; dtype* data_p = nullptr; size_t* data_size_p = nullptr; bool allocated_buffer = false; // assign data pointers insider buffer errflag_t assign_pointers() { if (this-\u003ebuffer_p != nullptr) { this-\u003ebuffer_size_p = (size_t*)this-\u003ebuffer_p; this-\u003edata_size_p = ((size_t*)this-\u003ebuffer_p) + 1; this-\u003edata_p = (dtype*)(((size_t*)this-\u003ebuffer_p) + 2); return SUCCESS; } return ERR_FAILED; } // initialize buffer and data pointers errflag_t init_buffer(size_t buffer_size) { errflag_t err_flag = ERR_NULL; if (this-\u003ebuffer_p == nullptr) { // allocate buffer this-\u003ebuffer_p = malloc(buffer_size); if (this-\u003ebuffer_p == nullptr) return ERR_MEMERR; memset(this-\u003ebuffer_p, 0, buffer_size); // assign pointers err_flag = this-\u003eassign_pointers(); // update type *(this-\u003ebuffer_size_p) = buffer_size; *(this-\u003edata_size_p) = 0; } this-\u003eallocated_buffer = true; return err_flag; } // free allocated buffer errflag_t free_buffer() { if (this-\u003eallocated_buffer) { // free buffer only when object allocated the buffer. if (this-\u003ebuffer_p != nullptr) { free(this-\u003ebuffer_p); } } return SUCCESS; } public: // constructor from existing buffer PageContainer(void* input_buffer_p, bool new_buffer = true) { errflag_t errflag = ERR_NULL; size_t buffer_size = *((size_t*)input_buffer_p); if (new_buffer) { errflag = this-\u003einit_buffer(buffer_size); memcpy(this-\u003ebuffer_p, input_buffer_p, buffer_size); } else { this-\u003ebuffer_p = input_buffer_p; errflag = this-\u003eassign_pointers(); } // throw error when failed if (errflag != SUCCESS) { throw std::runtime_error(\"PageContainer failed to init. Error flag = \" + std::to_string(errflag)); } } // constructor by giving max data size PageContainer(size_t capacity, size_t page_size) { errflag_t errflag = ERR_NULL; size_t nof_pages = (capacity + 2 * sizeof(size_t)) / page_size; if ((capacity + 2 * sizeof(size_t)) % page_size \u003e 0) nof_pages += 1; size_t buffer_size = nof_pages * page_size; errflag = this-\u003einit_buffer(buffer_size); // throw error when failed if (errflag != SUCCESS) { throw std::runtime_error(\"PageContainer failed to init. Error flag = \" + std::to_string(errflag)); } } // constructor by giving buffer size PageContainer(size_t buffer_size) { errflag_t errflag = ERR_NULL; errflag = this-\u003einit_buffer(buffer_size); // throw error when failed if (errflag != SUCCESS) { throw std::runtime_error(\"PageContainer failed to init. Error flag = \" + std::to_string(errflag)); } } // destuctor frees memory ~PageContainer() { this-\u003efree_buffer(); } // get the buffer pointer and size errflag_t get_buffer(void** buf_pp, size_t* buf_size_p) { *buf_pp = this-\u003ebuffer_p; *buf_size_p = *(this-\u003ebuffer_size_p); return SUCCESS; } // get data pointer errflag_t get_data_p(dtype** data_pp) { *data_pp = this-\u003edata_p; return SUCCESS; } // get capacity errflag_t get_capacity(size_t* capacity_p) { size_t capacity = *(this-\u003ebuffer_size_p) - 2; *capacity_p = capacity; return SUCCESS; } // get data size errflag_t get_data_size(size_t* data_size_p) { *data_size_p = *(this-\u003edata_size_p); return SUCCESS; } // set data size errflag_t set_data_size(size_t data_size) { errflag_t err_flag = ERR_NULL; size_t capacity = 0; err_flag = this-\u003eget_capacity(\u0026capacity); if (err_flag != SUCCESS) return err_flag; if (data_size \u003e capacity) { return ERR_FAILED; } *(this-\u003edata_size_p) = data_size; return SUCCESS; } }; } Data structure As shown in the cover image of this post, the main storage space of the PageContainer is a buffer sized as a multiple of the system page size. The first sizeof(size_t) bytes (8 bytes on 64-bit systems, 4 bytes on 32-bit systems) store the total size of the buffer. The next sizeof(size_t) bytes store the size of the valid data. The remaining space is used for data storage. Pointers are assigned for the entire buffer, the buffer size, the data size, and the data storage area.\nThis data structure setup allows data access without OS buffering and lets you store data that isn’t an exact multiple of the page size. By storing the buffer size and data size for each PageContainer object, you can store and access multiple PageContainer buffers within a single file without needing extra metadata.\nCreating and deleting a PageContainer When creating a PageContainer object, it allocates a buffer and organizes it based on the structure described earlier. The methods assign_pointers() and init_buffer() handle the allocation of the buffer and set up the necessary pointers.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // assign data pointers insider buffer errflag_t assign_pointers() { if (this-\u003ebuffer_p != nullptr) { this-\u003ebuffer_size_p = (size_t*)this-\u003ebuffer_p; this-\u003edata_size_p = ((size_t*)this-\u003ebuffer_p) + 1; this-\u003edata_p = (dtype*)(((size_t*)this-\u003ebuffer_p) + 2); return SUCCESS; } return ERR_FAILED; } // initialize buffer and data pointers errflag_t init_buffer(size_t buffer_size) { errflag_t err_flag = ERR_NULL; if (this-\u003ebuffer_p == nullptr) { // allocate buffer this-\u003ebuffer_p = malloc(buffer_size); if (this-\u003ebuffer_p == nullptr) return ERR_MEMERR; memset(this-\u003ebuffer_p, 0, buffer_size); // assign pointers err_flag = this-\u003eassign_pointers(); // update type *(this-\u003ebuffer_size_p) = buffer_size; *(this-\u003edata_size_p) = 0; } this-\u003eallocated_buffer = true; return err_flag; } With the methods for buffer allocation and arrangement in place, the constructors of the PageContainer can be defined simply as follows:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // constructor by giving buffer size PageContainer(size_t buffer_size) { errflag_t errflag = ERR_NULL; errflag = this-\u003einit_buffer(buffer_size); // throw error when failed if (errflag != SUCCESS) { throw std::runtime_error(\"PageContainer failed to init. Error flag = \" + std::to_string(errflag)); } } // constructor by giving max data size PageContainer(size_t capacity, size_t page_size) { errflag_t errflag = ERR_NULL; size_t nof_pages = (capacity + 2 * sizeof(size_t)) / page_size; if ((capacity + 2 * sizeof(size_t)) % page_size \u003e 0) nof_pages += 1; size_t buffer_size = nof_pages * page_size; errflag = this-\u003einit_buffer(buffer_size); // throw error when failed if (errflag != SUCCESS) { throw std::runtime_error(\"PageContainer failed to init. Error flag = \" + std::to_string(errflag)); } } Here, the first constructor accepts a directly calculated buffer size (buffer_size) from external sources. The second constructor takes expected maximum data size (capacity, in bytes) and system page size (page_size, in bytes) as inputs, calculating the minimum required buffer size accordingly.\nIn some applications, such as when loading a PageContainer buffer from a file or using intermediate buffering, there may already be memory allocated to store the buffer. In these cases, where pre-existing buffers are available, PageContainer also provides constructors that use these buffers directly, without allocating additional space.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // constructor from existing buffer PageContainer(void* input_buffer_p, bool new_buffer = true) { errflag_t errflag = ERR_NULL; size_t buffer_size = *((size_t*)input_buffer_p); if (new_buffer) { errflag = this-\u003einit_buffer(buffer_size); memcpy(this-\u003ebuffer_p, input_buffer_p, buffer_size); } else { this-\u003ebuffer_p = input_buffer_p; errflag = this-\u003eassign_pointers(); } // throw error when failed if (errflag != SUCCESS) { throw std::runtime_error(\"PageContainer failed to init. Error flag = \" + std::to_string(errflag)); } } To properly manage the dynamically allocated buffer, we have also defined the free_buffer() method as follows.\n1 2 3 4 5 6 7 8 9 // free allocated buffer errflag_t free_buffer() { if (this-\u003eallocated_buffer) { // free buffer only when object allocated the buffer. if (this-\u003ebuffer_p != nullptr) { free(this-\u003ebuffer_p); } } return SUCCESS; } In the PageContainer destructor, the buffer is freed if it was allocated during construction.\n1 2 3 4 // destuctor frees memory ~PageContainer() { this-\u003efree_buffer(); } Accessing data and buffer In data streaming applications, it’s common to have APIs that accept pointers to storage spaces for reading and writing data. Here’s a typical pesudo code of how such an API might be structured:\n1 2 errorflag_t write_data(handle_t file_handle, void* src_buffer, size_t bytes_to_write); errorflag_t read_data(handle_t file_handle, void* dst_buffer, size_t bytes_to_read, size_t* bytes_retrieved); Examples of such APIs include functions like WriteFile and ReadFile provided by the Windows API.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 BOOL WriteFile( [in] HANDLE hFile, [in] LPCVOID lpBuffer, [in] DWORD nNumberOfBytesToWrite, [out, optional] LPDWORD lpNumberOfBytesWritten, [in, out, optional] LPOVERLAPPED lpOverlapped ); BOOL ReadFile( [in] HANDLE hFile, [out] LPVOID lpBuffer, [in] DWORD nNumberOfBytesToRead, [out, optional] LPDWORD lpNumberOfBytesRead, [in, out, optional] LPOVERLAPPED lpOverlapped ); PageContainer offers the following methods to access data stored within it following such pointer data IO scheme.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // get data pointer errflag_t get_data_p(dtype** data_pp) { *data_pp = this-\u003edata_p; return SUCCESS; } // get capacity errflag_t get_capacity(size_t* capacity_p) { size_t capacity = *(this-\u003ebuffer_size_p) - 2; *capacity_p = capacity; return SUCCESS; } // get data size errflag_t get_data_size(size_t* data_size_p) { *data_size_p = *(this-\u003edata_size_p); return SUCCESS; } // set data size errflag_t set_data_size(size_t data_size) { errflag_t err_flag = ERR_NULL; size_t capacity = 0; err_flag = this-\u003eget_capacity(\u0026capacity); if (err_flag != SUCCESS) return err_flag; if (data_size \u003e capacity) { return ERR_FAILED; } *(this-\u003edata_size_p) = data_size; return SUCCESS; } The get_data_p() method provides a pointer to the storage space where data is stored. The get_capacity() method provides the maximum amount of data, in bytes, that the PageContainer can hold. The get_data_size() method provides the current size of the stored data in bytes. The set_data_size() method provides the size of the stored data when new data is written into the PageContainer.\nFor reading and writing operations that require data sizes to be multiples of the page size, PageContainer offers the following method to access the entire allocated buffer.\n1 2 3 4 5 6 // get the buffer pointer and size errflag_t get_buffer(void** buf_pp, size_t* buf_size_p) { *buf_pp = this-\u003ebuffer_p; *buf_size_p = *(this-\u003ebuffer_size_p); return SUCCESS; } Using PageContainer Here’s a quick example demonstrating how to use the PageContainer:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 void main() { std::wstring file_path = L\"test_file.bin\"; HANDLE file_handle = INVALID_HANDLE_VALUE; size_t page_size = 4 * 1024; // initial 4KB page size Container::errflag_t errflag = Container::ERR_NULL; DWORD error_flag = NULL; DWORD d_error = NULL; // get system page size SYSTEM_INFO sys_info; GetSystemInfo(\u0026sys_info); page_size = sys_info.dwPageSize; std::cout \u003c\u003c \"system page size: \" \u003c\u003c page_size \u003c\u003c std::endl; // initialize test array const size_t array_len = 10; float* test_array = new float[array_len]; size_t data_size = array_len * sizeof(float); for (size_t idx = 0; idx \u003c array_len; ++idx) { test_array[idx] = rand_float(0.0f, 1.0f, 1000); } std::cout \u003c\u003c \"write array: \" \u003c\u003c carray_to_string(test_array, array_len) \u003c\u003c std::endl; // create container with page size Container::PageContainer\u003cfloat\u003e write_container(array_len * sizeof(float), page_size); // copy data into container size_t data_size_to_write = data_size; float* write_data_p = nullptr; size_t write_capacity = 0; errflag = write_container.get_data_p(\u0026write_data_p); if (errflag != Container::SUCCESS) { std::cout \u003c\u003c \"ERR:\\t failed to access data pointer.\" \u003c\u003c std::endl; } write_container.get_capacity(\u0026write_capacity); memcpy(write_data_p, test_array, data_size_to_write); write_container.set_data_size(data_size_to_write); // write data to file (bypassing system buffer) // open file file_handle = CreateFileW( file_path.c_str(), GENERIC_WRITE | GENERIC_READ, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_NO_BUFFERING, NULL); if (file_handle == INVALID_HANDLE_VALUE) { std::cout \u003c\u003c \"ERR:\\t failed to create file.\" \u003c\u003c std::endl; return; } void* write_buffer_p = nullptr; size_t write_buffer_size = 0; write_container.get_buffer(\u0026write_buffer_p, \u0026write_buffer_size); // write data error_flag = WriteFile(file_handle, write_buffer_p, write_buffer_size, NULL, NULL); d_error = GetLastError(); if (error_flag == FALSE \u0026\u0026 d_error != ERROR_IO_PENDING) { std::cout \u003c\u003c \"ERR:\\t error in write file, error code = \" \u003c\u003c d_error \u003c\u003c std::endl; return; } // close file CloseHandle(file_handle); file_handle = INVALID_HANDLE_VALUE; std::cout \u003c\u003c \"data write to: \"; std::wcout \u003c\u003c file_path; std::cout \u003c\u003c std::endl; // read data from file void* read_buffer_p = nullptr; size_t read_buffer_size = 0; DWORD bytes_read = 0; // open file file_handle = CreateFileW( file_path.c_str(), GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL); if (file_handle == INVALID_HANDLE_VALUE) { std::cout \u003c\u003c \"ERR:\\t failed to create file.\" \u003c\u003c std::endl; return; } // get buffer size error_flag = ReadFile(file_handle, \u0026read_buffer_size, sizeof(size_t), \u0026bytes_read, NULL); d_error = GetLastError(); if (error_flag == FALSE \u0026\u0026 d_error != ERROR_IO_PENDING) { std::cout \u003c\u003c \"ERR:\\t error in read file, error code = \" \u003c\u003c d_error \u003c\u003c std::endl; return; } std::cout \u003c\u003c \"read_buffer_size = \" \u003c\u003c read_buffer_size \u003c\u003c std::endl; Container::PageContainer\u003cfloat\u003e read_container(read_buffer_size); read_container.get_buffer(\u0026read_buffer_p, \u0026read_buffer_size); // set file pointer to start of the buffer SetFilePointer(file_handle, 0, NULL, FILE_BEGIN); d_error = GetLastError(); if (d_error != 0) { std::cout \u003c\u003c \"ERR:\\t error set file pointer, error code = \" \u003c\u003c d_error \u003c\u003c std::endl; return; } // load buffer from the file error_flag = ReadFile(file_handle, read_buffer_p, read_buffer_size, \u0026bytes_read, NULL); d_error = GetLastError(); if (error_flag == FALSE \u0026\u0026 d_error != ERROR_IO_PENDING) { std::cout \u003c\u003c \"ERR:\\t error in read file, error code = \" \u003c\u003c d_error \u003c\u003c std::endl; return; } // close file CloseHandle(file_handle); file_handle = INVALID_HANDLE_VALUE; std::cout \u003c\u003c \"data read from: \"; std::wcout \u003c\u003c file_path; std::cout \u003c\u003c std::endl; // display read data float* read_arr = nullptr; size_t read_data_size = 0; size_t read_arr_len = 0; read_container.get_data_p(\u0026read_arr); read_container.get_data_size(\u0026read_data_size); read_arr_len = read_data_size / sizeof(float); std::cout \u003c\u003c \"read array: \" \u003c\u003c carray_to_string(read_arr, read_arr_len) \u003c\u003c std::endl; } In this example, we start by creating a PageContainer object (write_container) to store a float test array. The size of this array doesn’t match the system’s page size. We use the memcpy() function explicitly in the example to copy data into the PageContainer object. Next, we create a file with the FILE_FLAG_NO_BUFFERING flag, which disables Windows’ OS file buffering. We then write the entire buffer of the PageContainer object to this file and close it.\nLastly, we reopen the saved file to read the buffer size. Using this size, we create a new PageContainer object (read_container) and load the buffer from the file. Finally, we retrieve the array from the read_container.\nThe output displayed in the terminal for the demo code above is as follows:\nsystem page size: 4096\rwrite array: {0.041, 0.467, 0.334, 0.5, 0.169, 0.724, 0.478, 0.358, 0.962, 0.464}\rdata write to: test_file.bin\rread_buffer_size = 4096\rdata read from: test_file.bin\rread array: {0.041, 0.467, 0.334, 0.5, 0.169, 0.724, 0.478, 0.358, 0.962, 0.464} Conclusion By allocating a memory space sized in multiples of page sizes and organizing it into sections for storing buffer size, data size, and actual data, we created the PageContainer class. This setup enables direct reading and writing of data without relying on OS buffering.\nCitation If you found this article helpful, please cite it as:\nZhong, Jian (June 2024). PageContainer: Fast, Direct Data I/O Without OS Buffering. Vision Tech Insights. https://jianzhongdev.github.io/VisionTechInsights/posts/page_container_direct_data_io/.\nOr\n@article{zhong2024pagecontainer, title = \"PageContainer: Fast, Direct Data I/O Without OS Buffering\", author = \"Zhong, Jian\", journal = \"jianzhongdev.github.io\", year = \"2024\", month = \"June\", url = \"https://jianzhongdev.github.io/VisionTechInsights/posts/building_a_configuration_file_parser_with_cpp/.\" } ","wordCount":"2828","inLanguage":"en","image":"http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure.png","datePublished":"2024-06-13T00:00:00Z","dateModified":"2024-06-13T00:00:00Z","author":{"@type":"Person","name":"Jian Zhong"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/page_container_direct_data_io/"},"publisher":{"@type":"Organization","name":"Vision Tech Insights","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Vision Tech Insights (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Vision Tech Insights</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/posts/ title=Posts><span>Posts</span></a></li><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=http://localhost:1313/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">PageContainer: Fast, Direct Data I/O Without OS Buffering</h1><div class=post-description>A comprehensive guide on how to build a C++ data structure enabling direct data IO without OS buffering</div><div class=post-meta><span title='2024-06-13 00:00:00 +0000 UTC'>June 13, 2024</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;2828 words&nbsp;·&nbsp;Jian Zhong</div></header><figure class=entry-cover><img loading=eager srcset="http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure_hu2239e0ea4f6ef1095e731fc236afdff5_376452_360x0_resize_box_3.png 360w ,http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure_hu2239e0ea4f6ef1095e731fc236afdff5_376452_480x0_resize_box_3.png 480w ,http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure_hu2239e0ea4f6ef1095e731fc236afdff5_376452_720x0_resize_box_3.png 720w ,http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure_hu2239e0ea4f6ef1095e731fc236afdff5_376452_1080x0_resize_box_3.png 1080w ,http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure_hu2239e0ea4f6ef1095e731fc236afdff5_376452_1500x0_resize_box_3.png 1500w ,http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure.png 3510w" sizes="(min-width: 768px) 720px, 100vw" src=http://localhost:1313/images/page_container_direct_data_io/PageContainerDataStructure.png alt="[cover image] data structure of PageContainer (image credit: Jian Zhong)" width=3510 height=2100><p>[cover image] data structure of PageContainer (image credit: Jian Zhong)</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#container-class-requirements>Container Class Requirements</a></li><li><a href=#the-pagecontainer-class>The PageContainer Class</a><ul><li><a href=#data-structure>Data structure</a></li><li><a href=#creating-and-deleting-a-pagecontainer>Creating and deleting a PageContainer</a></li><li><a href=#accessing-data-and-buffer>Accessing data and buffer</a></li></ul></li><li><a href=#using-pagecontainer>Using PageContainer</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#citation>Citation</a></li></ul></nav></div></details></div><div class=post-content><p>When creating high-speed data streaming applications, it&rsquo;s important to avoid unnecessary data transfer to keep things fast and efficient. Operating systems (OS) automatically buffer file input/output (I/O) in the computer&rsquo;s memory. However, many data streaming applications already have their own buffering steps, making the OS&rsquo;s additional buffering unnecessary. Disabling this OS buffering allows direct control of data transfer, but it requires the application to access data in sizes that are multiples of the system page size (or disk sector size).</p><p>This blog post will show you how to build a C++ data structure called <code>PageContainer</code> that lets you access data without the OS buffering. You can find the ready-to-use source code for <code>PageContainer</code> in my <a href=https://github.com/JianZhongDev/PageContainer>Github repository</a>.(URL: <a href=https://github.com/JianZhongDev/PageContainer>https://github.com/JianZhongDev/PageContainer</a> )</p><h2 id=container-class-requirements>Container Class Requirements<a hidden class=anchor aria-hidden=true href=#container-class-requirements>#</a></h2><p>For applications that need to read and write large amounts of data without OS buffering, the data container should meet the following requirements:</p><ul><li>The buffer size should be a multiple of the page size.</li><li>It should be able to store data whose size does not perfectly match multiples of the page size</li><li>It should be capable of saving multiple containers within a large file.</li></ul><h2 id=the-pagecontainer-class>The PageContainer Class<a hidden class=anchor aria-hidden=true href=#the-pagecontainer-class>#</a></h2><p>To meet the requirements for accessing data without OS buffering, we can create a <code>PageContainer</code> class. The following sections will explain each part of this class in detail.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=k>namespace</span> <span class=n>Container</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>typedef</span> <span class=kt>int</span> <span class=n>errflag_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>static</span> <span class=k>const</span> <span class=n>errflag_t</span> <span class=n>ERR_NULL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>static</span> <span class=k>const</span> <span class=n>errflag_t</span> <span class=n>SUCCESS</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>static</span> <span class=k>const</span> <span class=n>errflag_t</span> <span class=n>ERR_FAILED</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>static</span> <span class=k>const</span> <span class=n>errflag_t</span> <span class=n>ERR_MEMERR</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// return errflag for fast error handling
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>template</span><span class=o>&lt;</span><span class=k>typename</span> <span class=n>dtype</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=k>class</span> <span class=nc>PageContainer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>private</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=kt>void</span><span class=o>*</span> <span class=n>buffer_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>size_t</span><span class=o>*</span> <span class=n>buffer_size_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>dtype</span><span class=o>*</span> <span class=n>data_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>size_t</span><span class=o>*</span> <span class=n>data_size_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>bool</span> <span class=n>allocated_buffer</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// assign data pointers insider buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>assign_pointers</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span> <span class=o>=</span> <span class=p>(</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span> <span class=o>=</span> <span class=p>((</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>this</span><span class=o>-&gt;</span><span class=n>data_p</span> <span class=o>=</span> <span class=p>(</span><span class=n>dtype</span><span class=o>*</span><span class=p>)(((</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>ERR_FAILED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// initialize buffer and data pointers
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>init_buffer</span><span class=p>(</span><span class=n>size_t</span> <span class=n>buffer_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag_t</span> <span class=n>err_flag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// allocate buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=k>return</span> <span class=n>ERR_MEMERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>memset</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=c1>// assign pointers
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>err_flag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>assign_pointers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=c1>// update type
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span><span class=p>)</span> <span class=o>=</span> <span class=n>buffer_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>-&gt;</span><span class=n>allocated_buffer</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>err_flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// free allocated buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>free_buffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>allocated_buffer</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// free buffer only when object allocated the buffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>free</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// constructor from existing buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>PageContainer</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span> <span class=n>input_buffer_p</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>new_buffer</span> <span class=o>=</span> <span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>size_t</span> <span class=n>buffer_size</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=n>input_buffer_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>new_buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>init_buffer</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>memcpy</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>,</span> <span class=n>input_buffer_p</span><span class=p>,</span> <span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>=</span> <span class=n>input_buffer_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>assign_pointers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// throw error when failed
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&#34;PageContainer failed to init. Error flag = &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>errflag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// constructor by giving max data size
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>PageContainer</span><span class=p>(</span><span class=n>size_t</span> <span class=n>capacity</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>page_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>size_t</span> <span class=n>nof_pages</span> <span class=o>=</span> <span class=p>(</span><span class=n>capacity</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>size_t</span><span class=p>))</span> <span class=o>/</span> <span class=n>page_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>capacity</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>size_t</span><span class=p>))</span> <span class=o>%</span> <span class=n>page_size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>nof_pages</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>size_t</span> <span class=n>buffer_size</span> <span class=o>=</span> <span class=n>nof_pages</span> <span class=o>*</span> <span class=n>page_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>init_buffer</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=c1>// throw error when failed
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&#34;PageContainer failed to init. Error flag = &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>errflag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// constructor by giving buffer size
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>PageContainer</span><span class=p>(</span><span class=n>size_t</span> <span class=n>buffer_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>init_buffer</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=c1>// throw error when failed
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&#34;PageContainer failed to init. Error flag = &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>errflag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// destuctor frees memory
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>~</span><span class=n>PageContainer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>-&gt;</span><span class=n>free_buffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// get the buffer pointer and size
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>get_buffer</span><span class=p>(</span><span class=kt>void</span><span class=o>**</span> <span class=n>buf_pp</span><span class=p>,</span> <span class=n>size_t</span><span class=o>*</span> <span class=n>buf_size_p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=n>buf_pp</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=n>buf_size_p</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// get data pointer 
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>get_data_p</span><span class=p>(</span><span class=n>dtype</span><span class=o>**</span> <span class=n>data_pp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=n>data_pp</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>data_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// get capacity
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>get_capacity</span><span class=p>(</span><span class=n>size_t</span><span class=o>*</span> <span class=n>capacity_p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>size_t</span> <span class=n>capacity</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=n>capacity_p</span> <span class=o>=</span> <span class=n>capacity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// get data size
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>get_data_size</span><span class=p>(</span><span class=n>size_t</span><span class=o>*</span> <span class=n>data_size_p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=n>data_size_p</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// set data size
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>errflag_t</span> <span class=nf>set_data_size</span><span class=p>(</span><span class=n>size_t</span> <span class=n>data_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>errflag_t</span> <span class=n>err_flag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>size_t</span> <span class=n>capacity</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>			<span class=n>err_flag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>get_capacity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>capacity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>err_flag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=k>return</span> <span class=n>err_flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>data_size</span> <span class=o>&gt;</span> <span class=n>capacity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>ERR_FAILED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span><span class=p>)</span> <span class=o>=</span> <span class=n>data_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=data-structure>Data structure<a hidden class=anchor aria-hidden=true href=#data-structure>#</a></h3><p>As shown in the <strong>cover image</strong> of this post, the main storage space of the <code>PageContainer</code> is a buffer sized as a multiple of the system page size. The first <code>sizeof(size_t)</code> bytes (8 bytes on 64-bit systems, 4 bytes on 32-bit systems) store the total size of the buffer. The next <code>sizeof(size_t)</code> bytes store the size of the valid data. The remaining space is used for data storage. Pointers are assigned for the entire buffer, the buffer size, the data size, and the data storage area.</p><p>This data structure setup allows data access without OS buffering and lets you store data that isn&rsquo;t an exact multiple of the page size. By storing the buffer size and data size for each <code>PageContainer</code> object, you can store and access multiple <code>PageContainer</code> buffers within a single file without needing extra metadata.</p><h3 id=creating-and-deleting-a-pagecontainer>Creating and deleting a PageContainer<a hidden class=anchor aria-hidden=true href=#creating-and-deleting-a-pagecontainer>#</a></h3><p>When creating a PageContainer object, it allocates a buffer and organizes it based on the structure described earlier. The methods <code>assign_pointers()</code> and <code>init_buffer()</code> handle the allocation of the buffer and set up the necessary pointers.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// assign data pointers insider buffer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>assign_pointers</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span> <span class=o>=</span> <span class=p>(</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span> <span class=o>=</span> <span class=p>((</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>-&gt;</span><span class=n>data_p</span> <span class=o>=</span> <span class=p>(</span><span class=n>dtype</span><span class=o>*</span><span class=p>)(((</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ERR_FAILED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// initialize buffer and data pointers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>init_buffer</span><span class=p>(</span><span class=n>size_t</span> <span class=n>buffer_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag_t</span> <span class=n>err_flag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// allocate buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=k>return</span> <span class=n>ERR_MEMERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>memset</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=c1>// assign pointers
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>err_flag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>assign_pointers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=c1>// update type
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span><span class=p>)</span> <span class=o>=</span> <span class=n>buffer_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=o>-&gt;</span><span class=n>allocated_buffer</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>err_flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>With the methods for buffer allocation and arrangement in place, the constructors of the PageContainer can be defined simply as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// constructor by giving buffer size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PageContainer</span><span class=p>(</span><span class=n>size_t</span> <span class=n>buffer_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>init_buffer</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// throw error when failed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&#34;PageContainer failed to init. Error flag = &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>errflag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// constructor by giving max data size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PageContainer</span><span class=p>(</span><span class=n>size_t</span> <span class=n>capacity</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>page_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>nof_pages</span> <span class=o>=</span> <span class=p>(</span><span class=n>capacity</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>size_t</span><span class=p>))</span> <span class=o>/</span> <span class=n>page_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>((</span><span class=n>capacity</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>size_t</span><span class=p>))</span> <span class=o>%</span> <span class=n>page_size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>nof_pages</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>buffer_size</span> <span class=o>=</span> <span class=n>nof_pages</span> <span class=o>*</span> <span class=n>page_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>init_buffer</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>// throw error when failed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&#34;PageContainer failed to init. Error flag = &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>errflag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Here, the first constructor accepts a directly calculated buffer size (<code>buffer_size</code>) from external sources. The second constructor takes expected maximum data size (<code>capacity</code>, in bytes) and system page size (<code>page_size</code>, in bytes) as inputs, calculating the minimum required buffer size accordingly.</p><p>In some applications, such as when loading a <code>PageContainer</code> buffer from a file or using intermediate buffering, there may already be memory allocated to store the buffer. In these cases, where pre-existing buffers are available, <code>PageContainer</code> also provides constructors that use these buffers directly, without allocating additional space.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// constructor from existing buffer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>PageContainer</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span> <span class=n>input_buffer_p</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>new_buffer</span> <span class=o>=</span> <span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>buffer_size</span> <span class=o>=</span> <span class=o>*</span><span class=p>((</span><span class=n>size_t</span><span class=o>*</span><span class=p>)</span><span class=n>input_buffer_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>new_buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>init_buffer</span><span class=p>(</span><span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>memcpy</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>,</span> <span class=n>input_buffer_p</span><span class=p>,</span> <span class=n>buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>=</span> <span class=n>input_buffer_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>errflag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>assign_pointers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// throw error when failed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>runtime_error</span><span class=p>(</span><span class=s>&#34;PageContainer failed to init. Error flag = &#34;</span> <span class=o>+</span> <span class=n>std</span><span class=o>::</span><span class=n>to_string</span><span class=p>(</span><span class=n>errflag</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>To properly manage the dynamically allocated buffer, we have also defined the <code>free_buffer()</code> method as follows.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// free allocated buffer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>free_buffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>allocated_buffer</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// free buffer only when object allocated the buffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>free</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In the <code>PageContainer</code> destructor, the buffer is freed if it was allocated during construction.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// destuctor frees memory
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>~</span><span class=n>PageContainer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>this</span><span class=o>-&gt;</span><span class=n>free_buffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=accessing-data-and-buffer>Accessing data and buffer<a hidden class=anchor aria-hidden=true href=#accessing-data-and-buffer>#</a></h3><p>In data streaming applications, it&rsquo;s common to have APIs that accept pointers to storage spaces for reading and writing data. Here&rsquo;s a typical pesudo code of how such an API might be structured:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=n>errorflag_t</span> <span class=nf>write_data</span><span class=p>(</span><span class=n>handle_t</span> <span class=n>file_handle</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span> <span class=n>src_buffer</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>bytes_to_write</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>errorflag_t</span> <span class=nf>read_data</span><span class=p>(</span><span class=n>handle_t</span> <span class=n>file_handle</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span> <span class=n>dst_buffer</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>bytes_to_read</span><span class=p>,</span> <span class=n>size_t</span><span class=o>*</span> <span class=n>bytes_retrieved</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Examples of such APIs include functions like <a href=https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile><code>WriteFile</code></a> and <a href=https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile><code>ReadFile</code></a> provided by the Windows API.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=n>BOOL</span> <span class=nf>WriteFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>]</span>                <span class=n>HANDLE</span>       <span class=n>hFile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>]</span>                <span class=n>LPCVOID</span>      <span class=n>lpBuffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>]</span>                <span class=n>DWORD</span>        <span class=n>nNumberOfBytesToWrite</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>out</span><span class=p>,</span> <span class=n>optional</span><span class=p>]</span>     <span class=n>LPDWORD</span>      <span class=n>lpNumberOfBytesWritten</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>optional</span><span class=p>]</span> <span class=n>LPOVERLAPPED</span> <span class=n>lpOverlapped</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BOOL</span> <span class=nf>ReadFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>]</span>                <span class=n>HANDLE</span>       <span class=n>hFile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>out</span><span class=p>]</span>               <span class=n>LPVOID</span>       <span class=n>lpBuffer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>]</span>                <span class=n>DWORD</span>        <span class=n>nNumberOfBytesToRead</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>out</span><span class=p>,</span> <span class=n>optional</span><span class=p>]</span>     <span class=n>LPDWORD</span>      <span class=n>lpNumberOfBytesRead</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=n>in</span><span class=p>,</span> <span class=n>out</span><span class=p>,</span> <span class=n>optional</span><span class=p>]</span> <span class=n>LPOVERLAPPED</span> <span class=n>lpOverlapped</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><code>PageContainer</code> offers the following methods to access data stored within it following such pointer data IO scheme.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// get data pointer 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>get_data_p</span><span class=p>(</span><span class=n>dtype</span><span class=o>**</span> <span class=n>data_pp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>data_pp</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>data_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// get capacity
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>get_capacity</span><span class=p>(</span><span class=n>size_t</span><span class=o>*</span> <span class=n>capacity_p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>capacity</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>capacity_p</span> <span class=o>=</span> <span class=n>capacity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// get data size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>get_data_size</span><span class=p>(</span><span class=n>size_t</span><span class=o>*</span> <span class=n>data_size_p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>data_size_p</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// set data size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>set_data_size</span><span class=p>(</span><span class=n>size_t</span> <span class=n>data_size</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag_t</span> <span class=n>err_flag</span> <span class=o>=</span> <span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>capacity</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>	<span class=n>err_flag</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>get_capacity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>capacity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>err_flag</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=k>return</span> <span class=n>err_flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>data_size</span> <span class=o>&gt;</span> <span class=n>capacity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>ERR_FAILED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>data_size_p</span><span class=p>)</span> <span class=o>=</span> <span class=n>data_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>get_data_p()</code> method provides a pointer to the storage space where data is stored. The <code>get_capacity()</code> method provides the maximum amount of data, in bytes, that the <code>PageContainer</code> can hold. The <code>get_data_size()</code> method provides the current size of the stored data in bytes. The <code>set_data_size()</code> method provides the size of the stored data when new data is written into the <code>PageContainer</code>.</p><p>For reading and writing operations that require data sizes to be multiples of the page size, <code>PageContainer</code> offers the following method to access the entire allocated buffer.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=c1>// get the buffer pointer and size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>errflag_t</span> <span class=nf>get_buffer</span><span class=p>(</span><span class=kt>void</span><span class=o>**</span> <span class=n>buf_pp</span><span class=p>,</span> <span class=n>size_t</span><span class=o>*</span> <span class=n>buf_size_p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>buf_pp</span> <span class=o>=</span> <span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=n>buf_size_p</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=k>this</span><span class=o>-&gt;</span><span class=n>buffer_size_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=using-pagecontainer>Using PageContainer<a hidden class=anchor aria-hidden=true href=#using-pagecontainer>#</a></h2><p>Here&rsquo;s a quick example demonstrating how to use the <code>PageContainer</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C++ data-lang=C++><span class=line><span class=cl><span class=kt>void</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>wstring</span> <span class=n>file_path</span> <span class=o>=</span> <span class=sa>L</span><span class=s>&#34;test_file.bin&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>HANDLE</span> <span class=n>file_handle</span> <span class=o>=</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>page_size</span> <span class=o>=</span> <span class=mi>4</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>;</span> <span class=c1>// initial 4KB page size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>Container</span><span class=o>::</span><span class=n>errflag_t</span> <span class=n>errflag</span> <span class=o>=</span> <span class=n>Container</span><span class=o>::</span><span class=n>ERR_NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>DWORD</span> <span class=n>error_flag</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>DWORD</span> <span class=n>d_error</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// get system page size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>SYSTEM_INFO</span> <span class=n>sys_info</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GetSystemInfo</span><span class=p>(</span><span class=o>&amp;</span><span class=n>sys_info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>page_size</span> <span class=o>=</span> <span class=n>sys_info</span><span class=p>.</span><span class=n>dwPageSize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;system page size: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>page_size</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// initialize test array
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>const</span> <span class=n>size_t</span> <span class=n>array_len</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>float</span><span class=o>*</span> <span class=n>test_array</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>float</span><span class=p>[</span><span class=n>array_len</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>data_size</span> <span class=o>=</span> <span class=n>array_len</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>float</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>size_t</span> <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>idx</span> <span class=o>&lt;</span> <span class=n>array_len</span><span class=p>;</span> <span class=o>++</span><span class=n>idx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>test_array</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>rand_float</span><span class=p>(</span><span class=mf>0.0f</span><span class=p>,</span> <span class=mf>1.0f</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;write array: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>carray_to_string</span><span class=p>(</span><span class=n>test_array</span><span class=p>,</span> <span class=n>array_len</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// create container with page size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>Container</span><span class=o>::</span><span class=n>PageContainer</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>write_container</span><span class=p>(</span><span class=n>array_len</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>float</span><span class=p>),</span> <span class=n>page_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1>// copy data into container 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>size_t</span> <span class=n>data_size_to_write</span> <span class=o>=</span> <span class=n>data_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>float</span><span class=o>*</span> <span class=n>write_data_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>write_capacity</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>errflag</span> <span class=o>=</span> <span class=n>write_container</span><span class=p>.</span><span class=n>get_data_p</span><span class=p>(</span><span class=o>&amp;</span><span class=n>write_data_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>errflag</span> <span class=o>!=</span> <span class=n>Container</span><span class=o>::</span><span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> failed to access data pointer.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>write_container</span><span class=p>.</span><span class=n>get_capacity</span><span class=p>(</span><span class=o>&amp;</span><span class=n>write_capacity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>memcpy</span><span class=p>(</span><span class=n>write_data_p</span><span class=p>,</span> <span class=n>test_array</span><span class=p>,</span> <span class=n>data_size_to_write</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>write_container</span><span class=p>.</span><span class=n>set_data_size</span><span class=p>(</span><span class=n>data_size_to_write</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// write data to file (bypassing system buffer)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// open file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>file_handle</span> <span class=o>=</span> <span class=n>CreateFileW</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=n>file_path</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=n>GENERIC_WRITE</span> <span class=o>|</span> <span class=n>GENERIC_READ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>CREATE_ALWAYS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>FILE_ATTRIBUTE_NORMAL</span> <span class=o>|</span> <span class=n>FILE_FLAG_NO_BUFFERING</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>		<span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file_handle</span> <span class=o>==</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> failed to create file.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kt>void</span><span class=o>*</span> <span class=n>write_buffer_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>write_buffer_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>write_container</span><span class=p>.</span><span class=n>get_buffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>write_buffer_p</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>write_buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// write data
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>error_flag</span> <span class=o>=</span> <span class=n>WriteFile</span><span class=p>(</span><span class=n>file_handle</span><span class=p>,</span> <span class=n>write_buffer_p</span><span class=p>,</span> <span class=n>write_buffer_size</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>d_error</span> <span class=o>=</span> <span class=n>GetLastError</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>error_flag</span> <span class=o>==</span> <span class=n>FALSE</span> <span class=o>&amp;&amp;</span> <span class=n>d_error</span> <span class=o>!=</span> <span class=n>ERROR_IO_PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> error in write file, error code = &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>d_error</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// close file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>CloseHandle</span><span class=p>(</span><span class=n>file_handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>file_handle</span> <span class=o>=</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;data write to: &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>wcout</span> <span class=o>&lt;&lt;</span> <span class=n>file_path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// read data from file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>void</span><span class=o>*</span> <span class=n>read_buffer_p</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>read_buffer_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>DWORD</span> <span class=n>bytes_read</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// open file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>file_handle</span> <span class=o>=</span> <span class=n>CreateFileW</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=n>file_path</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=n>GENERIC_READ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>OPEN_EXISTING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=n>FILE_ATTRIBUTE_NORMAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>file_handle</span> <span class=o>==</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> failed to create file.&#34;</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// get buffer size
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>error_flag</span> <span class=o>=</span> <span class=n>ReadFile</span><span class=p>(</span><span class=n>file_handle</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>read_buffer_size</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>size_t</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>bytes_read</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>d_error</span> <span class=o>=</span> <span class=n>GetLastError</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>error_flag</span> <span class=o>==</span> <span class=n>FALSE</span> <span class=o>&amp;&amp;</span> <span class=n>d_error</span> <span class=o>!=</span> <span class=n>ERROR_IO_PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> error in read file, error code = &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>d_error</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;read_buffer_size = &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>read_buffer_size</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>Container</span><span class=o>::</span><span class=n>PageContainer</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>read_container</span><span class=p>(</span><span class=n>read_buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>read_container</span><span class=p>.</span><span class=n>get_buffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>read_buffer_p</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>read_buffer_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// set file pointer to start of the buffer 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>SetFilePointer</span><span class=p>(</span><span class=n>file_handle</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>FILE_BEGIN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>d_error</span> <span class=o>=</span> <span class=n>GetLastError</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>d_error</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> error set file pointer, error code = &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>d_error</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// load buffer from the file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>error_flag</span> <span class=o>=</span> <span class=n>ReadFile</span><span class=p>(</span><span class=n>file_handle</span><span class=p>,</span> <span class=n>read_buffer_p</span><span class=p>,</span> <span class=n>read_buffer_size</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>bytes_read</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>d_error</span> <span class=o>=</span> <span class=n>GetLastError</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>error_flag</span> <span class=o>==</span> <span class=n>FALSE</span> <span class=o>&amp;&amp;</span> <span class=n>d_error</span> <span class=o>!=</span> <span class=n>ERROR_IO_PENDING</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;ERR:</span><span class=se>\t</span><span class=s> error in read file, error code = &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>d_error</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// close file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>CloseHandle</span><span class=p>(</span><span class=n>file_handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>file_handle</span> <span class=o>=</span> <span class=n>INVALID_HANDLE_VALUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;data read from: &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>wcout</span> <span class=o>&lt;&lt;</span> <span class=n>file_path</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// display read data
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>float</span><span class=o>*</span> <span class=n>read_arr</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>read_data_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>size_t</span> <span class=n>read_arr_len</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>read_container</span><span class=p>.</span><span class=n>get_data_p</span><span class=p>(</span><span class=o>&amp;</span><span class=n>read_arr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>read_container</span><span class=p>.</span><span class=n>get_data_size</span><span class=p>(</span><span class=o>&amp;</span><span class=n>read_data_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>read_arr_len</span> <span class=o>=</span> <span class=n>read_data_size</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>float</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=n>std</span><span class=o>::</span><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=s>&#34;read array: &#34;</span> <span class=o>&lt;&lt;</span> <span class=n>carray_to_string</span><span class=p>(</span><span class=n>read_arr</span><span class=p>,</span> <span class=n>read_arr_len</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In this example, we start by creating a <code>PageContainer</code> object (<code>write_container</code>) to store a float test array. The size of this array doesn&rsquo;t match the system&rsquo;s page size. We use the <code>memcpy()</code> function explicitly in the example to copy data into the <code>PageContainer</code> object.
Next, we create a file with the <code>FILE_FLAG_NO_BUFFERING</code> flag, which disables Windows&rsquo; OS file buffering. We then write the entire buffer of the <code>PageContainer</code> object to this file and close it.</p><p>Lastly, we reopen the saved file to read the buffer size. Using this size, we create a new <code>PageContainer</code> object (<code>read_container</code>) and load the buffer from the file. Finally, we retrieve the array from the <code>read_container</code>.</p><p>The output displayed in the terminal for the demo code above is as follows:</p><pre tabindex=0><code>system page size: 4096
write array: {0.041, 0.467, 0.334, 0.5, 0.169, 0.724, 0.478, 0.358, 0.962, 0.464}
data write to: test_file.bin
read_buffer_size = 4096
data read from: test_file.bin
read array: {0.041, 0.467, 0.334, 0.5, 0.169, 0.724, 0.478, 0.358, 0.962, 0.464}
</code></pre><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>By allocating a memory space sized in multiples of page sizes and organizing it into sections for storing buffer size, data size, and actual data, we created the <code>PageContainer</code> class. This setup enables direct reading and writing of data without relying on OS buffering.</p><h2 id=citation>Citation<a hidden class=anchor aria-hidden=true href=#citation>#</a></h2><p>If you found this article helpful, please cite it as:</p><blockquote><p>Zhong, Jian (June 2024). PageContainer: Fast, Direct Data I/O Without OS Buffering. Vision Tech Insights. <a href=https://jianzhongdev.github.io/VisionTechInsights/posts/page_container_direct_data_io/>https://jianzhongdev.github.io/VisionTechInsights/posts/page_container_direct_data_io/</a>.</p></blockquote><p>Or</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>@article{zhong2024pagecontainer,
</span></span><span class=line><span class=cl>  title   = &#34;PageContainer: Fast, Direct Data I/O Without OS Buffering&#34;,
</span></span><span class=line><span class=cl>  author  = &#34;Zhong, Jian&#34;,
</span></span><span class=line><span class=cl>  journal = &#34;jianzhongdev.github.io&#34;,
</span></span><span class=line><span class=cl>  year    = &#34;2024&#34;,
</span></span><span class=line><span class=cl>  month   = &#34;June&#34;,
</span></span><span class=line><span class=cl>  url     = &#34;https://jianzhongdev.github.io/VisionTechInsights/posts/building_a_configuration_file_parser_with_cpp/.&#34;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/hardware-programming/>Hardware Programming</a></li><li><a href=http://localhost:1313/tags/c++/>C++</a></li></ul><nav class=paginav><a class=next href=http://localhost:1313/posts/implement_train_vgg_pytorch/><span class=title>Next »</span><br><span>Building and Training VGG with PyTorch: A Step-by-Step Guide</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on x" href="https://x.com/intent/tweet/?text=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f&amp;hashtags=hardwareprogramming%2cC%2b%2b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f&amp;title=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering&amp;summary=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f&title=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on whatsapp" href="https://api.whatsapp.com/send?text=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on telegram" href="https://telegram.me/share/url?text=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share PageContainer: Fast, Direct Data I/O Without OS Buffering on ycombinator" href="https://news.ycombinator.com/submitlink?t=PageContainer%3a%20Fast%2c%20Direct%20Data%20I%2fO%20Without%20OS%20Buffering&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fpage_container_direct_data_io%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Vision Tech Insights</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>